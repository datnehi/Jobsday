<div class="search-bar-sticky py-5" style="
    background: url('assets/baner4.jpg') center center/cover no-repeat;
    width: 99.5vw;
    margin-left: calc(-50vw + 50%);
    margin-right: calc(-50vw + 50%);
    border-radius: 0;
  ">
  <div class="container" style="max-width:1200px;">
    <div class="d-flex align-items-center justify-content-center gap-3">
      <div class="flex-grow-1">
        <div class="d-flex align-items-center rounded-pill shadow-sm" style="background: #f8f9fa; height: 48px;">
          <i class="bi bi-search text-secondary ms-4 me-2"></i>
          <input type="text" class="form-control border-0 bg-transparent"
            placeholder="Tìm kiếm kỹ năng, vị trí, công ty..." [(ngModel)]="searchText"
            style="box-shadow:none; min-width: 180px; background:transparent;">
          <button *ngIf="searchText" class="btn btn-link text-secondary px-2" style="width: 40px;"
            (click)="searchText=''">
            <i class="bi bi-x-lg me-3"></i>
          </button>
        </div>
      </div>
      <button class="btn btn-primary rounded-pill px-4 ms-2" (click)="search()" style="font-weight:bold; height:48px;">
        Tìm kiếm
      </button>
    </div>
  </div>
</div>

<div class="container" style="max-width:1200px; margin-top: 30px;">
  <div class="row justify-content-center">
    <div class="col-lg-3 mb-4">
      <div class="bg-white rounded shadow-sm p-3 mb-3 d-flex flex-column sidebar-sticky" style="height: 700px;">
        <h5 class="fw-bold mb-3 text-primary flex-shrink-0">
          <i class="bi bi-funnel"></i> Lọc nâng cao
        </h5>
        <div style="overflow-y: auto; flex-grow: 1;">
          <div class="mb-3 ms-1">
            <label class="fw-bold mb-2">Địa điểm</label>
            <div *ngFor="let location of locations">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="location" [checked]="selectedLocations === location"
                  (change)="selectLocation(location)">
                <label class="form-check-label">{{ location }}</label>
              </div>
            </div>
          </div>
          <div class="mb-3 ms-1">
            <label class="fw-bold mb-2">Kinh nghiệm</label>
            <div *ngFor="let exp of experiences">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="exp" [checked]="selectedExperience === exp"
                  (change)="selectExperience(exp)">
                <label class="form-check-label">{{ exp }}</label>
              </div>
            </div>
          </div>
          <div class="mb-3 ms-1">
            <label class="fw-bold mb-2">Cấp bậc</label>
            <div *ngFor="let level of levels">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="level" [checked]="selectedLevel === level"
                  (change)="selectLevel(level)">
                <label class="form-check-label">{{ level }}</label>
              </div>
            </div>
          </div>
          <div class="mb-3 ms-1">
            <label class="fw-bold mb-2">Mức lương</label>
            <div *ngFor="let salary of salaries">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="salary" [checked]="selectedSalary === salary"
                  (change)="selectSalary(salary)">
                <label class="form-check-label">{{ salary }}</label>
              </div>
            </div>
          </div>
          <div class="mb-3 ms-1">
            <label class="fw-bold mb-2">Hình thức làm việc</label>
            <div *ngFor="let workType of workTypes">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="workType" [checked]="selectedWorkType === workType"
                  (change)="selectWorkType(workType)">
                <label class="form-check-label">{{ workType }}</label>
              </div>
            </div>
          </div>
          <div class="mb-3 ms-1">
            <label class="fw-bold mb-2">Loại hợp đồng</label>
            <div *ngFor="let contractType of contractTypes">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="contractType"
                  [checked]="selectedContractType === contractType" (change)="selectContractType(contractType)">
                <label class="form-check-label">{{ contractType }}</label>
              </div>
            </div>
          </div>
        </div>
        <button class="btn btn-outline-secondary w-100 mt-2 flex-shrink-0" (click)="clearFilters()">Xóa lọc</button>
      </div>
    </div>
    <div class="col-lg-9">
      <div class="bg-white rounded shadow-sm p-3 mb-4">
        <div class="nav nav-tabs border-0">
          <span class="tab-hover" [ngClass]="{
              'fw-bold text-primary border-bottom border-3 border-primary': selectedTab === 'jobs',
              'text-dark': selectedTab !== 'jobs'
            }" (click)="onTabChange('jobs')" style="cursor:pointer; padding: 8px 16px;">
            Việc làm
          </span>
          <span class="tab-hover" [ngClass]="{
              'fw-bold text-primary border-bottom border-3 border-primary': selectedTab === 'companies',
              'text-dark': selectedTab !== 'companies'
            }" (click)="onTabChange('companies')" style="cursor:pointer; padding: 8px 16px;">
            Công ty
          </span>
        </div>
      </div>
      <div *ngIf="selectedTab === 'jobs'">
        <div *ngFor="let job of jobs; let i = index" class="card job-card mb-3" (mouseenter)="hoveredJobIndex = i"
          (mouseleave)="hoveredJobIndex = null" (click)="openJobDetail(job.id)"
          style="position: relative; cursor: pointer;">
          <div class="card-body d-flex gap-4">
            <img [src]="job.companyLogo || 'assets/logo1.png'" alt="Logo" width="120" height="120"
                class="rounded bg-white border" (error)="onLogoError($event)"/>
            <div class="flex-grow-1">
              <h3 class="h6 fw-bold text-primary mb-1">
                {{ job.title }}
              </h3>
              <div class="text-muted mb-2">{{ job.companyName }}</div>
              <div class="d-flex gap-4 mb-2">
                <div class="text-primary">{{ job.salary }}</div>
                <div class="text-muted">{{ job.level }}</div>
              </div>
              <div class="d-flex flex-wrap gap-2 text-secondary mb-2">
                <span>{{ job.location }}</span>
                <span *ngIf="job.jobType">({{ job.jobType }})</span>
              </div>
              <hr class="w-100 my-2">
              <div class="d-flex justify-content-between align-items-center" style="height: 34px; position: relative;">
                <div>
                  <span class="badge bg-primary me-1" *ngFor="let skill of job.skills.slice(0, 3)">{{ skill }}</span>
                  <span *ngIf="job.skills.length > 3" class="badge bg-primary me-1"
                    [title]="job.skills.slice(3).join(', ')" style="cursor: pointer;">
                    +{{ job.skills.length - 3 }}
                  </span>
                </div>
                <div *ngIf="job.applied || (!job.applied && hoveredJobIndex === i)"
                  style="position: absolute; right: 0; bottom: -5px; display: flex; align-items: center;">
                  <span class="text-muted small" style="margin-right: 8px;">
                    {{ getPostedLabel(job.postedAt) }}
                  </span>
                  <button *ngIf="job.applied" class="btn"
                    style="background: #6c757d; color: #fff; font-weight: bold; border-radius: 20px; min-width: 90px;"
                    disabled>
                    Đã ứng tuyển <i class="bi bi-check-lg"></i>
                  </button>
                  <button *ngIf="!job.applied && hoveredJobIndex === i" class="btn"
                    style="background: #007bff; color: #fff; font-weight: bold; border-radius: 20px; min-width: 90px;"
                    (click)="openJobDetail(job.id); $event.stopPropagation()">
                    Ứng tuyển
                  </button>
                </div>
                <span *ngIf="!job.applied && hoveredJobIndex !== i" class="text-muted small"
                  style="position: absolute; right: 0; bottom: 0;">
                  {{ getPostedLabel(job.postedAt) }}
                </span>
              </div>
            </div>
            <button *ngIf="!job.saved" class="btn btn-outline-primary" aria-label="Lưu tin"
              style="position: absolute; top: 16px; right: 16px; z-index: 2;"
              (click)="onSaveClick(job); $event.stopPropagation()">
              <i class="bi bi-heart"></i>
            </button>
            <button *ngIf="job.saved" class="btn btn-outline-primary" aria-label="Bỏ lưu"
              style="position: absolute; top: 16px; right: 16px; z-index: 2;"
              (click)="onUnsaveClick(job); $event.stopPropagation()">
              <i class="bi bi-heart-fill"></i>
            </button>
          </div>
        </div>
      </div>
      <div *ngIf="selectedTab === 'companies'">
        <div *ngFor="let company of companies" class="card company-card mb-3" (click)="openCompanyDetail(company.id)">
          <div class="card-body d-flex gap-4 align-items-center">
            <img [src]="company.logo || 'assets/logo1.png'" alt="Logo" width="100" height="100"
                class="rounded bg-white border" (error)="onLogoError($event)"/>
            <div class="flex-grow-1">
              <h3 class="h6 fw-bold text-primary mb-1">{{ company.name }}</h3>
              <div class="text-muted mb-2">{{ company.location }}</div>
              <div>
                <span class="badge bg-primary me-1" *ngFor="let skill of company.skills">{{ skill }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="selectedTab === 'jobs' && totalPages > 1"
        class="d-flex justify-content-center align-items-center gap-3 my-3">
        <button class="btn btn-outline-primary rounded-circle px-2" [disabled]="currentPage === 0"
          (click)="changePage(currentPage - 1, 'jobs')" style="width: 36px; height: 36px;" aria-label="Trang trước">
          <i class="bi bi-chevron-left"></i>
        </button>
        <span class="fw-bold text-primary" style="font-size: 1.1rem;">
          {{ currentPage + 1 }} <span class="text-muted">/ {{ totalPages }} trang</span>
        </span>
        <button class="btn btn-outline-primary rounded-circle px-2" [disabled]="currentPage + 1 >= totalPages"
          (click)="changePage(currentPage + 1, 'jobs')" style="width: 36px; height: 36px;" aria-label="Trang sau">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>

      <div *ngIf="selectedTab === 'companies' && companiesTotalPages > 1"
        class="d-flex justify-content-center align-items-center gap-3 my-3">
        <button class="btn btn-outline-primary rounded-circle px-2" [disabled]="companiesCurrentPage === 0"
          (click)="changePage(companiesCurrentPage - 1, 'companies')" style="width: 36px; height: 36px;"
          aria-label="Trang trước">
          <i class="bi bi-chevron-left"></i>
        </button>
        <span class="fw-bold text-primary" style="font-size: 1.1rem;">
          {{ companiesCurrentPage + 1 }} <span class="text-muted">/ {{ companiesTotalPages }} trang</span>
        </span>
        <button class="btn btn-outline-primary rounded-circle px-2"
          [disabled]="companiesCurrentPage + 1 >= companiesTotalPages"
          (click)="changePage(companiesCurrentPage + 1, 'companies')" style="width: 36px; height: 36px;"
          aria-label="Trang sau">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<app-login-dialog [show]="showLoginDialog" (close)="showLoginDialog = false"></app-login-dialog>

<app-error-dialog
  *ngIf="showErrorDialog"
  [title]="errorTitle"
  [message]="errorMessage"
  (cancel)="handleCancel()">
</app-error-dialog>

<app-loading *ngIf="isLoading"></app-loading>
