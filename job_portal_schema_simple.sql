CREATE TYPE user_role_enum AS ENUM ('CANDIDATE', 'HR', 'ADMIN');
CREATE TYPE user_status_enum AS ENUM ('ACTIVE', 'INACTIVE');
CREATE TYPE company_status_enum AS ENUM ('PENDING', 'APPROVED', 'INACTIVE', 'REJECTED');
CREATE TYPE member_status_enum AS ENUM ('PENDING', 'APPROVED', 'REJECTED', 'INACTIVE');
CREATE TYPE application_status_enum AS ENUM ('APPLIED','VIEWED','SUITABLE','UNSUITABLE');
CREATE TYPE job_status_enum AS ENUM ('ACTIVE','HIDDEN','CLOSED');
CREATE TYPE salary_enum AS ENUM ('DUOI_10_TRIEU', 'TU_10_DEN_15_TRIEU', 'TU_15_DEN_20_TRIEU', 'TU_20_DEN_25_TRIEU', 'TU_25_DEN_30_TRIEU', 'TU_30_DEN_50_TRIEU', 'TREN_50_TRIEU', 'THOA_THUAN');
CREATE TYPE level_enum AS ENUM ('FRESHER', 'INTERN', 'JUNIOR', 'MIDDLE', 'SENIOR');
CREATE TYPE experience_enum AS ENUM ('KHONG_YEU_CAU', 'DUOI_1_NAM', 'MOT_NAM', 'HAI_NAM', 'BA_NAM', 'BON_NAM', 'NAM_NAM', 'TREN_5_NAM');
CREATE TYPE job_type_enum AS ENUM ('IN_OFFICE', 'HYBRID', 'REMOTE');
CREATE TYPE contract_type_enum AS ENUM ('FULL_TIME', 'PART_TIME', 'FREELANCE');
CREATE TYPE location_enum AS ENUM ('HANOI','DANANG','HOCHIMINH');

CREATE TABLE users (
    id              		BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    email           		TEXT NOT NULL UNIQUE,
    password_hash  			TEXT NOT NULL,
    full_name       		TEXT NOT NULL,
    phone           		CHAR(10),
    dob             		DATE,
	address					TEXT,
    avatar_url      		TEXT,
    role            		user_role_enum NOT NULL DEFAULT 'CANDIDATE',
    status          		user_status_enum NOT NULL DEFAULT 'ACTIVE',
    created_at      		TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at      		TIMESTAMP NOT NULL DEFAULT NOW(),
	email_verified  		BOOLEAN NOT NULL DEFAULT FALSE,
	verification_code 		TEXT,
	verification_expiry 	TIMESTAMP,
	ntd_search 				BOOLEAN NOT NULL DEFAULT FALSE
);

ALTER TABLE users
ADD COLUMN is_online BOOLEAN DEFAULT FALSE,
ADD COLUMN last_online_at TIMESTAMP;

CREATE TABLE companies (
    id              BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name            TEXT NOT NULL,
	location		location_enum NOT NULL,
	logo			TEXT,
    address         TEXT NOT NULL,
    website         TEXT,
    tax_code        TEXT,
	email			TEXT,
    description     TEXT,
    status          company_status_enum NOT NULL DEFAULT 'PENDING',
    created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

ALTER TABLE companies ADD COLUMN search_tsv tsvector;

CREATE OR REPLACE FUNCTION companies_search_trigger() RETURNS trigger AS $$
BEGIN
  NEW.search_tsv :=
    to_tsvector('english', coalesce(NEW.name, '')) ||
    to_tsvector('simple', coalesce(NEW.name, ''));
  RETURN NEW;
END
$$ LANGUAGE plpgsql;

CREATE TRIGGER companies_tsvector_update
BEFORE INSERT OR UPDATE ON companies
FOR EACH ROW EXECUTE FUNCTION companies_search_trigger();

CREATE INDEX companies_search_tsv_idx ON companies USING gin(search_tsv);

ALTER TABLE companies
ADD COLUMN is_online BOOLEAN DEFAULT FALSE,
ADD COLUMN last_online_at TIMESTAMP;

CREATE TABLE company_members (
    id              BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    company_id      BIGINT NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    user_id         BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
	position		TEXT,
    is_admin        BOOLEAN NOT NULL DEFAULT FALSE,
    status          member_status_enum NOT NULL DEFAULT 'PENDING',
    created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE (company_id, user_id)
);

CREATE TABLE hr_view_candidate (
    id              BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    hr_id      		BIGINT NOT NULL REFERENCES company_members(id) ON DELETE CASCADE,
    candidate_id    BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    updated_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE cvs (
    id              BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id         BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title           TEXT NOT NULL,
    file_url        TEXT NOT NULL,
    level           level_enum, 
    experience      experience_enum,     
    job_title       TEXT,               
    content         TEXT,                    
    content_tsv     tsvector, 
    is_public       BOOLEAN NOT NULL DEFAULT FALSE,
    created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_cvs_content_tsv ON cvs USING GIN (content_tsv);

CREATE FUNCTION cvs_tsvector_update() RETURNS trigger AS $$
BEGIN
  NEW.content_tsv :=
    to_tsvector('english', coalesce(NEW.content, '')) || 
	to_tsvector('simple', coalesce(NEW.content, ''));
  RETURN NEW;
END
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_cvs_tsvector_update
BEFORE INSERT OR UPDATE OF content
ON cvs
FOR EACH ROW
EXECUTE FUNCTION cvs_tsvector_update();

CREATE TABLE jobs (
    id              BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    company_id      BIGINT NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
	member_id     	BIGINT NOT NULL REFERENCES company_members(id) ON DELETE CASCADE,
    title           TEXT NOT NULL,
    location        location_enum NOT NULL,
	address 		TEXT NOT NULL,
    description     TEXT NOT NULL,
	requirement		TEXT NOT NULL,
	benefit			TEXT NOT NULL,
	working_time	TEXT NOT NULL,
    job_type        job_type_enum NOT NULL,
	level			level_enum NOT NULL,
	contract_type	contract_type_enum NOT NULL,
	salary			salary_enum NOT NULL,
	experience		experience_enum NOT NULL,
	quantity		INT NOT NULL,
	deadline		DATE NOT NULL,
    status          job_status_enum NOT NULL DEFAULT 'ACTIVE',
    created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP NOT NULL DEFAULT NOW(),
	search_tsv		tsvector
);

CREATE OR REPLACE FUNCTION jobs_search_trigger() RETURNS trigger AS $$
BEGIN
  NEW.search_tsv :=
    to_tsvector('english', coalesce(NEW.title, '')) ||
    to_tsvector('simple', coalesce(NEW.title, ''));
  RETURN NEW;
END
$$ LANGUAGE plpgsql;

CREATE TRIGGER jobs_tsvector_update
BEFORE INSERT OR UPDATE ON jobs
FOR EACH ROW EXECUTE FUNCTION jobs_search_trigger();

CREATE INDEX jobs_search_tsv_idx ON jobs USING gin(search_tsv);

CREATE TABLE applications (
    id              BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    job_id          BIGINT NOT NULL REFERENCES jobs(id) ON DELETE CASCADE,
    candidate_id    BIGINT NOT NULL REFERENCES users(id) ON DELETE NO CASCADE,
	file_name 		TEXT NOT NULL,
    cv_url          TEXT NOT NULL,
    cover_letter    TEXT,
    status          application_status_enum NOT NULL DEFAULT 'APPLIED',
    applied_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE (job_id, candidate_id)
);

CREATE TABLE notifications (
    id              BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	user_from       BIGINT REFERENCES users(id) ON DELETE CASCADE,
    user_to         BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
	title			TEXT NOT NULL,
    message         TEXT NOT NULL,
	url				TEXT,
    is_read         BOOLEAN NOT NULL DEFAULT FALSE,
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE skills (
    id      BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name    TEXT NOT NULL UNIQUE
);

CREATE TABLE company_skills (
    company_id      BIGINT NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    skill_id    	BIGINT NOT NULL REFERENCES skills(id) ON DELETE CASCADE,
    PRIMARY KEY (company_id, skill_id)
);

CREATE TABLE job_skills (
    job_id      BIGINT NOT NULL REFERENCES jobs(id) ON DELETE CASCADE,
    skill_id    BIGINT NOT NULL REFERENCES skills(id) ON DELETE CASCADE,
    PRIMARY KEY (job_id, skill_id)
);

CREATE TABLE cv_skills (
    cv_id       BIGINT NOT NULL REFERENCES cvs(id) ON DELETE CASCADE,
    skill_id    BIGINT NOT NULL REFERENCES skills(id) ON DELETE CASCADE,
    PRIMARY KEY (cv_id, skill_id)
);

CREATE TABLE saved_jobs (
    id 				BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    candidate_id 	BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    job_id 			BIGINT NOT NULL REFERENCES jobs(id) ON DELETE CASCADE,
    saved_at 		TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(candidate_id, job_id)
);

CREATE EXTENSION IF NOT EXISTS pg_trgm;

CREATE TABLE conversations (
    id              BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    company_id      BIGINT NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    candidate_id    BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
	last_message 	TEXT,
	last_message_at TIMESTAMP,
    created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE (company_id, candidate_id)
);

ALTER TABLE conversations
ADD COLUMN IF NOT EXISTS company_last_read_at TIMESTAMP,
ADD COLUMN IF NOT EXISTS candidate_last_read_at TIMESTAMP;

CREATE INDEX idx_conversations_candidate_last_read ON conversations(candidate_id, last_message_at, candidate_last_read_at);
CREATE INDEX idx_conversations_company_last_read ON conversations(company_id, last_message_at, company_last_read_at);

CREATE TABLE messages (
    id              BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    conversation_id BIGINT NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
    sender_id       BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    content         TEXT NOT NULL,
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_messages_conversation_created_at ON messages(conversation_id, created_at DESC);

ALTER TABLE messages ADD COLUMN IF NOT EXISTS seen_at TIMESTAMP;
CREATE INDEX idx_messages_conversation_sender_seen ON messages (conversation_id, sender_id, seen_at, created_at);


DO $$
DECLARE
    rec RECORD;
    tbl_name text;
    col_name text;
    seq_name text;
    last_id bigint;
BEGIN
    -- Lấy tất cả các sequence trong DB (thường gắn với SERIAL/IDENTITY)
    FOR rec IN
        SELECT
            n.nspname AS schema_name,
            c.relname AS seq_name,
            t.relname AS tbl_name,
            a.attname AS col_name
        FROM pg_class c
        JOIN pg_namespace n ON n.oid = c.relnamespace
        JOIN pg_depend d ON d.objid = c.oid
        JOIN pg_class t ON d.refobjid = t.oid
        JOIN pg_attribute a ON d.refobjid = a.attrelid AND d.refobjsubid = a.attnum
        WHERE c.relkind = 'S'
    LOOP
        seq_name := rec.schema_name || '.' || rec.seq_name;
        tbl_name := rec.schema_name || '.' || rec.tbl_name;
        col_name := rec.col_name;

        -- Lấy MAX(id) của bảng
        EXECUTE format('SELECT COALESCE(MAX(%I), 1) FROM %s', col_name, tbl_name) INTO last_id;

        -- Reset sequence về đúng giá trị MAX(id)
        EXECUTE format('SELECT setval(%L, %s, false)', seq_name, last_id);
    END LOOP;
END$$;

INSERT INTO skills (name) VALUES
('Java'), ('Spring Boot'), ('PostgreSQL'),
('React'), ('Angular'), ('TypeScript'),
('Docker'), ('AWS'), ('Kubernetes'),
('JavaScript'),
('Python'),
('C#'),
('C++'),
('C'),
('Go'),
('Rust'),
('Kotlin'),
('Swift'),
('PHP'),
('Ruby'),
('Dart'),
('Scala'),
('HTML'),
('CSS'),
('Sass'),
('Tailwind CSS'),
('Bootstrap'),
('Next.js'),
('Vue.js'),
('Nuxt.js'),
('jQuery'),
('Spring Framework'),
('.NET Core'),
('ASP.NET'),
('Express.js'),
('NestJS'),
('Django'),
('Flask'),
('FastAPI'),
('Ruby on Rails'),
('Laravel'),
('Symfony'),
('Golang Gin'),
('MySQL'),
('SQL Server'),
('SQLite'),
('Oracle'),
('MongoDB'),
('Redis'),
('Elasticsearch'),
('Firebase'),
('Cassandra'),
('Jenkins'),
('GitLab CI/CD'),
('GitHub Actions'),
('Google Cloud Platform'),
('Microsoft Azure'),
('Terraform'),
('Ansible'),
('Git'),
('Linux'),
('Bash Scripting'),
('REST API'),
('GraphQL'),
('gRPC'),
('Microservices'),
('Event-Driven Architecture'),
('Clean Architecture'),
('Design Patterns'),
('Pandas'),
('NumPy'),
('TensorFlow'),
('PyTorch'),
('Scikit-learn'),
('Machine Learning'),
('Deep Learning'),
('Data Analysis'),
('Data Visualization'),
('MLOps'),
('Android'),
('iOS'),
('Flutter'),
('React Native'),
('SwiftUI'),
('Jetpack Compose'),
('JUnit'),
('Mockito'),
('Selenium'),
('Cypress'),
('Playwright'),
('Jest'),
('Mocha'),
('Chai'),
('Postman'),
('OAuth 2.0'),
('OpenID Connect'),
('JWT'),
('Penetration Testing'),
('OWASP Top 10'),
('HTTPS'),
('SSO'),
('Agile'),
('Scrum'),
('Kanban'),
('Jira'),
('Confluence'),
('CI/CD'),
('Unit Testing'),
('Integration Testing'),
('Code Review'),
('Refactoring');
