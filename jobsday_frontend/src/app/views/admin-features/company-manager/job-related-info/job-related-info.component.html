<div class="container mt-4">
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0">{{ job.title }}</h4>
    </div>
    <div class="card-body" style="padding-bottom: unset;">
      <div class="row mb-2">
        <div class="col-md-4">
          <p><strong>Công ty: </strong><a routerLink="/company-related-info/{{company.id}}">{{ company.name }}</a></p>
          <p><strong>Người phụ trách: </strong><a routerLink="/hr-related-info/{{member.id}}">{{user.fullName}}</a> -
            {{member.position}}</p>
          <p><strong>Địa điểm:</strong> {{ job.location }}</p>
          <p><strong>Địa chỉ:</strong> {{ job.address }}</p>
          <p><strong>Thời gian làm việc:</strong> {{ job.workingTime }}</p>
          <p><strong>Loại công việc:</strong> {{ job.jobType }}</p>
          <p><strong>Cấp bậc:</strong> {{ job.level }}</p>
          <p><strong>Hình thức hợp đồng:</strong> {{ job.contractType }}</p>
          <p><strong>Lương:</strong> {{ job.salary }}</p>
          <p><strong>Kinh nghiệm:</strong> {{ job.experience }}</p>
          <p><strong>Số lượng tuyển:</strong> {{ job.quantity }}</p>
          <p><strong>Hạn nộp:</strong> {{ job.deadline | date:'dd/MM/yyyy' }}</p>
          <p><strong>Trạng thái: </strong><span [ngClass]="{
            'badge bg-primary text-white': job.status === 'ACTIVE',
            'badge bg-secondary text-white': job.status === 'HIDDEN',
            'badge bg-danger text-white': job.status === 'CLOSED',
          }">{{ job.status }}</span></p>
          <button type="button" class="btn btn-primary me-2" (click)="openUpdateJob()">Sửa Job</button>
          <button type="button" class="btn btn-danger" (click)="openConfirm('deleteJob')">Xóa Job</button>
        </div>
        <div class="col-md-8">
          <p><strong>Mô tả công việc:</strong></p>
          <div class="border rounded p-2 mb-2" style="height: 25%;">
            <span [innerHTML]="job.description | newlineToBr"></span>
          </div>
          <p><strong>Yêu cầu:</strong></p>
          <div class="border rounded p-2 mb-2" style="height: 25%;">
            <span [innerHTML]="job.requirement | newlineToBr"></span>
          </div>
          <p><strong>Quyền lợi:</strong></p>
          <div class="border rounded p-2" style="height: 25%;">
            <span [innerHTML]="job.benefit | newlineToBr"></span>
          </div>
        </div>
        <div class="text-end text-muted">
          <small>Ngày tạo: {{ job.createdAt | date:'dd/MM/yyyy HH:mm' }} | Cập nhật: {{ job.updatedAt |
            date:'dd/MM/yyyy HH:mm' }}</small>
        </div>
      </div>
    </div>
  </div>

  <h5 class="mb-3 text-center">Danh sách ứng viên đã ứng tuyển</h5>
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-primary">
        <tr>
          <th scope="col" class="text-center">Họ tên</th>
          <th scope="col" class="text-center">Email</th>
          <th scope="col" class="text-center" style="width: 9em;">Số điện thoại</th>
          <th scope="col" class="text-center" style="width: 7em;">CV</th>
          <th scope="col" class="text-center" style="width: 10em;">Ngày ứng tuyển</th>
          <th scope="col" class="text-center" style="width: 7em;">Trạng thái</th>
          <th scope="col" class="text-center" style="width: 8em;">Hành động</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let application of applications; let i = index" routerLink="/candidate/{{application.candidateId}}"
          style="cursor: pointer;">
          <td class="text-center align-middle">{{ application.candidateName }}</td>
          <td class="text-center align-middle">{{ application.candidateEmail }}</td>
          <td class="text-center align-middle">{{ application.candidatePhone }}</td>
          <td class="text-center align-middle">
            <a (click)="viewCv(application.applicationId); $event.stopPropagation();"
              class="btn btn-sm btn-outline-primary">Xem CV</a>
          </td>
          <td class="text-center align-middle">{{ application.appliedAt | date:'dd/MM/yyyy hh:mm' }}</td>
          <td class="text-center align-middle">
            <span class="status-badge" [ngClass]="{
              'badge bg-success': application.status === 'APPLIED',
              'badge bg-warning': application.status === 'VIEWED',
              'badge bg-primary': application.status === 'SUITABLE',
              'badge bg-secondary': application.status === 'UNSUITABLE'
              }">
              {{ application.status }}
            </span>
          </td>
          <td class="text-center align-middle">
            <button class="btn btn-outline-primary btn-sm me-2"
              (click)="viewDetail(application); $event.stopPropagation();" title="Chi tiết">
              Xem
            </button>
            <button class="btn btn-outline-danger btn-sm"
              (click)="openConfirm('deleteApplication', application); $event.stopPropagation();" title="delete">
              Xóa
            </button>
          </td>
        </tr>
        <tr *ngIf="applications.length === 0">
          <td colspan="8" class="text-center align-middle">Chưa có ứng viên nào ứng tuyển</td>
        </tr>
      </tbody>
    </table>
  </div>
  <div *ngIf="totalPages > 1" class="d-flex justify-content-center align-items-center gap-3">
    <button class="btn btn-outline-primary rounded-circle px-2" [disabled]="currentPage === 0"
      (click)="changePage(currentPage - 1)" style="width: 36px; height: 36px;" aria-label="Trang trước">
      <i class="bi bi-chevron-left"></i>
    </button>
    <span class="fw-bold text-primary" style="font-size: 1.1rem;">
      {{ currentPage + 1 }} <span class="text-muted">/ {{ totalPages }} trang</span>
    </span>
    <button class="btn btn-outline-primary rounded-circle px-2" [disabled]="currentPage + 1 >= totalPages"
      (click)="changePage(currentPage + 1)" style="width: 36px; height: 36px;" aria-label="Trang sau">
      <i class="bi bi-chevron-right"></i>
    </button>
  </div>
</div>

<div class="modal fade" tabindex="-1" [class.show]="showDetailDialog"
  [style.display]="showDetailDialog ? 'block' : 'none'" style="background: rgba(0,0,0,0.2); z-index: 1;"
  *ngIf="showDetailDialog" (click)="closeDetailDialog()">
  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Chi tiết ứng tuyển</h5>
        <button type="button" class="btn-close btn-outline" (click)="closeDetailDialog()"></button>
      </div>
      <div class="modal-body" *ngIf="selectedApplication">
        <div class="mb-2"><strong>CV: </strong> <a (click)="viewCv(selectedApplication.id)" class="text-primary"
            style="cursor: pointer;">Xem CV</a></div>
        <div class="mb-2"><strong>Thư ứng tuyển:</strong>
          <div class="border rounded p-2" style="height: 200px;">
            <span [innerHTML]="selectedApplication.coverLetter | newlineToBr"></span>
          </div>
        </div>
        <div class="mb-2"><strong>Ngày ứng tuyển:</strong> {{ selectedApplication.appliedAt | date:'dd/MM/yyyy HH:mm'}}
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeDetailDialog()">Đóng</button>
      </div>
    </div>
  </div>
</div>

<app-notification-dialog *ngIf="showConfirmDialog" [title]="confirmTitle" [message]="confirmMessage"
  (confirm)="handleConfirm()" (cancel)="handleCancel()">
</app-notification-dialog>

<app-error-dialog *ngIf="showErrorDialog" [title]="errorTitle" [message]="errorMessage" (cancel)="handleCancelError()">
</app-error-dialog>

<app-loading *ngIf="isLoading"></app-loading>

<div class="modal fade" tabindex="-1" [class.show]="showDetailDialog"
  [style.display]="showDetailDialog ? 'block' : 'none'" style="background: rgba(0,0,0,0.2); z-index: 1;"
  *ngIf="showDetailDialog" (click)="closeDetailDialog()">
  <div class="modal-dialog modal-dialog-centered modal-lg" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Chi tiết ứng viên</h5>
        <button type="button" class="btn-close btn-outline" (click)="closeDetailDialog()"></button>
      </div>
      <div class="modal-body" *ngIf="selectedApplication">
        <div class="row">
          <div class="col-md-4 d-flex flex-column align-items-center border-end justify-content-center">
            <img [src]="selectedApplication.candidateAvatar || 'assets/user.jpg'" alt="Avatar"
              class="rounded-circle mb-3" style="width: 100px; height: 100px; object-fit: cover;">
            <div class="fw-bold fs-5 mb-2">{{ selectedApplication.candidateName }}</div>
            <div class="mb-2" *ngIf="selectedApplication.candidateEmail"><i class="bi bi-envelope"></i> {{
              selectedApplication.candidateEmail }}</div>
            <div class="mb-2" *ngIf="selectedApplication.candidatePhone"><i class="bi bi-telephone"></i> {{
              selectedApplication.candidatePhone }}</div>
          </div>
          <div class="col-md-8">
            <div class="mb-2"><strong>CV: </strong> <a (click)="viewCv(selectedApplication.applicationId)"
                class="text-primary" style="cursor: pointer;">Xem CV</a></div>
            <div class="mb-2"><strong>Thư ứng tuyển:</strong>
              <div class="border rounded p-2" style="height: 200px;">
                <span [innerHTML]="selectedApplication.coverLetter | newlineToBr"></span>
              </div>
            </div>
            <div class="mb-2"><strong>Ngày ứng tuyển:</strong> {{ selectedApplication.appliedAt | date:'dd/MM/yyyy
              HH:mm' }}</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeDetailDialog()">Đóng</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade show d-block" *ngIf="showUpdateJobModal" style="background: rgba(0,0,0,0.3);"
  (click)="closeUpdateJobModal()">
  <div class="modal-dialog modal-xl modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <form [formGroup]="jobForm" (ngSubmit)="openConfirm('updateJob')">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title fw-bold">Chỉnh sửa tin tuyển dụng</h5>
          <button type="button" class="btn-close" (click)="closeUpdateJobModal()"></button>
        </div>

        <div class="modal-body">
          <div class="row mb-2">
            <div class="mb-1 text-danger small"><span class="fw-bold">*</span> Các thông tin bắt buộc</div>
            <div class="col-md-6 mb-2">
              <label class="form-label fw-bold">Vị trí tuyển dụng <span class="text-danger fw-bold">*</span></label>
              <input type="text" class="form-control" formControlName="title" placeholder="Nhập vị trí tuyển dụng">
              <div
                *ngIf="jobForm.get('title')?.invalid && (jobForm.get('title')?.dirty || jobForm.get('title')?.touched)"
                class="text-danger">Vị trí tuyển dụng không được để trống.</div>
            </div>

            <div class="col-md-6 mb-2">
              <label class="form-label fw-bold">Địa chỉ <span class="text-danger fw-bold">*</span></label>
              <input type="text" class="form-control" formControlName="address" placeholder="Nhập địa chỉ">
              <div
                *ngIf="jobForm.get('address')?.invalid && (jobForm.get('address')?.dirty || jobForm.get('address')?.touched)"
                class="text-danger">Địa chỉ không được để trống.</div>
            </div>

            <div class="col-md-3 mb-2">
              <label class="form-label fw-bold">Người phụ trách <span class="text-danger fw-bold">*</span></label>
              <select class="form-select" formControlName="memberName">
                <option value="">Chọn người phụ trách</option>
                <option *ngFor="let m of members" [value]="m.id">{{ m.fullName }} - {{ m.position }}</option>
              </select>
              <div
                *ngIf="jobForm.get('memberName')?.invalid && (jobForm.get('memberName')?.dirty || jobForm.get('memberName')?.touched)"
                class="text-danger">Người phụ trách không được để trống.</div>
            </div>

            <div class="col-md-3 mb-2">
              <label class="form-label fw-bold">Địa điểm <span class="text-danger fw-bold">*</span></label>
              <select class="form-select" formControlName="location">
                <option value="">Chọn địa điểm</option>
                <option value="HANOI">Hà Nội</option>
                <option value="HOCHIMINH">Hồ Chí Minh</option>
                <option value="DANANG">Đà Nẵng</option>
              </select>
              <div
                *ngIf="jobForm.get('location')?.invalid && (jobForm.get('location')?.dirty || jobForm.get('location')?.touched)"
                class="text-danger">Địa điểm không được để trống.</div>
            </div>


            <div class="col-md-3 mb-2">
              <label class="form-label fw-bold">Số lượng tuyển <span class="text-danger fw-bold">*</span></label>
              <input type="number" class="form-control" formControlName="quantity" min="1">
              <div
                *ngIf="jobForm.get('quantity')?.invalid && (jobForm.get('quantity')?.dirty || jobForm.get('quantity')?.touched)"
                class="text-danger">
                <ng-container *ngIf="jobForm.get('quantity')?.errors?.['required']; else quantityOtherErrors">
                  Số lượng tuyển không được để trống.
                </ng-container>
                <ng-template #quantityOtherErrors>
                  <ng-container *ngIf="jobForm.get('quantity')?.errors?.['min']">
                    Số lượng tuyển phải lớn hơn hoặc bằng 1.
                  </ng-container>
                </ng-template>
              </div>
            </div>

            <div class="col-md-3 mb-2">
              <label class="form-label fw-bold">Hạn ứng tuyển <span class="text-danger fw-bold">*</span></label>
              <input type="date" class="form-control" formControlName="deadline" [attr.min]="today | date:'yyyy-MM-dd'">
              <div
                *ngIf="jobForm.get('deadline')?.invalid && (jobForm.get('deadline')?.dirty || jobForm.get('deadline')?.touched)"
                class="text-danger">
                <ng-container *ngIf="jobForm.get('deadline')?.errors?.['required']; else deadlineOtherErrors">
                  Hạn ứng tuyển không được để trống.
                </ng-container>
                <ng-template #deadlineOtherErrors>
                  <ng-container *ngIf="jobForm.get('deadline')?.errors?.['invalidDate']; else notPastOrToday">
                    Hạn ứng tuyển không hợp lệ.
                  </ng-container>
                  <ng-template #notPastOrToday>
                    <ng-container *ngIf="jobForm.get('deadline')?.errors?.['pastOrToday']">
                      Hạn ứng tuyển phải lớn hơn ngày hiện tại.
                    </ng-container>
                  </ng-template>
                </ng-template>
              </div>
            </div>

            <div class="col-md-3 mb-2">
              <label class="form-label fw-bold">Mức lương <span class="text-danger fw-bold">*</span></label>
              <select class="form-select" formControlName="salary">
                <option value="">Chọn mức lương</option>
                <option value="THOA_THUAN">Thỏa thuận</option>
                <option value="DUOI_10_TRIEU">Dưới 10 triệu</option>
                <option value="TU_10_DEN_15_TRIEU">10 - 15 triệu</option>
                <option value="TU_15_DEN_20_TRIEU">15 - 20 triệu</option>
                <option value="TU_20_DEN_25_TRIEU">20 - 25 triệu</option>
                <option value="TU_25_DEN_30_TRIEU">25 - 30 triệu</option>
                <option value="TU_30_DEN_50_TRIEU">30 - 50 triệu</option>
                <option value="HON_50_TRIEU">Trên 50 triệu</option>
              </select>
              <div
                *ngIf="jobForm.get('salary')?.invalid && (jobForm.get('salary')?.dirty || jobForm.get('salary')?.touched)"
                class="text-danger">Mức lương không được để trống.</div>
            </div>

            <div class="col-md-3 mb-2">
              <label class="form-label fw-bold">Loại hợp đồng <span class="text-danger fw-bold">*</span></label>
              <select class="form-select" formControlName="contractType">
                <option value="">Chọn loại hợp đồng</option>
                <option value="FULL_TIME">Toàn thời gian</option>
                <option value="PART_TIME">Bán thời gian</option>
                <option value="FREELANCE">Freelance</option>
              </select>
              <div
                *ngIf="jobForm.get('contractType')?.invalid && (jobForm.get('contractType')?.dirty || jobForm.get('contractType')?.touched)"
                class="text-danger">Loại hợp đồng không được để trống.</div>
            </div>

            <div class="col-md-3 mb-2">
              <label class="form-label fw-bold">Kinh nghiệm <span class="text-danger fw-bold">*</span></label>
              <select class="form-select" formControlName="experience">
                <option value="">Chọn kinh nghiệm</option>
                <option value="KHONG_YEU_CAU">Không yêu cầu</option>
                <option value="DUOI_1_NAM">Dưới 1 năm</option>
                <option value="MOT_NAM">1 năm</option>
                <option value="HAI_NAM">2 năm</option>
                <option value="BA_NAM">3 năm</option>
                <option value="BON_NAM">4 năm</option>
                <option value="NAM_NAM">5 năm</option>
                <option value="TREN_5_NAM">Trên 5 năm</option>
              </select>
              <div
                *ngIf="jobForm.get('experience')?.invalid && (jobForm.get('experience')?.dirty || jobForm.get('experience')?.touched)"
                class="text-danger">Kinh nghiệm không được để trống.</div>
            </div>

            <div class="col-md-3 mb-2">
              <label class="form-label fw-bold">Cấp bậc <span class="text-danger fw-bold">*</span></label>
              <select class="form-select" formControlName="level">
                <option value="">Chọn cấp bậc</option>
                <option value="INTERN">Intern</option>
                <option value="FRESHER">Fresher</option>
                <option value="JUNIOR">Junior</option>
                <option value="SENIOR">Senior</option>
              </select>
              <div
                *ngIf="jobForm.get('level')?.invalid && (jobForm.get('level')?.dirty || jobForm.get('level')?.touched)"
                class="text-danger">Cấp bậc không được để trống.</div>
            </div>

            <div class="col-md-3 mb-2">
              <label class="form-label fw-bold">Hình thức làm việc <span class="text-danger fw-bold">*</span></label>
              <select class="form-select" formControlName="jobType">
                <option value="">Chọn hình thức</option>
                <option value="IN_OFFICE">Tại văn phòng</option>
                <option value="REMOTE">Remote</option>
                <option value="HYBRID">Hybrid</option>
              </select>
              <div
                *ngIf="jobForm.get('jobType')?.invalid && (jobForm.get('jobType')?.dirty || jobForm.get('jobType')?.touched)"
                class="text-danger">Hình thức làm việc không được để trống.</div>
            </div>

            <div class="col-md-6 mb-2">
              <label class="form-label fw-bold">Thời gian làm việc <span class="text-danger fw-bold">*</span></label>
              <input class="form-control" formControlName="workingTime"
                placeholder="Ví dụ: Thứ 2 - Thứ 6, 8:00 - 17:00">
              <div
                *ngIf="jobForm.get('workingTime')?.invalid && (jobForm.get('workingTime')?.dirty || jobForm.get('workingTime')?.touched)"
                class="text-danger">Thời gian làm việc không được để trống.</div>
            </div>

            <div class="col-md-3 mb-2">
              <label class="form-label fw-bold">Trạng thái <span class="text-danger fw-bold">*</span></label>
              <select class="form-select" formControlName="status">
                <option value="">Chọn trạng thái</option>
                <option value="ACTIVE">Đang hoạt động</option>
                <option value="HIDDEN">Ẩn</option>
                <option value="CLOSED">Đã đóng</option>
              </select>
              <div
                *ngIf="jobForm.get('status')?.invalid && (jobForm.get('status')?.dirty || jobForm.get('status')?.touched)"
                class="text-danger">Trạng thái không được để trống.</div>
            </div>

            <div class="col-md-12 mb-2">
              <label class="form-label fw-bold">Kỹ năng yêu cầu</label>
              <ng-select *ngIf="skillsList" [items]="skillsList" bindLabel="name" bindValue="id" [multiple]="true"
                formControlName="skills" class="form-control" [closeOnSelect]="false">
                <ng-template ng-option-tmp let-item="item">
                  <div class="skill-option">
                    <input type="checkbox" [checked]="jobForm.value.skills?.includes(item.id)"
                      (change)="onSkillChange(item.id, $event)" style="margin-right:8px;">
                    {{ item.name }}
                  </div>
                </ng-template>
              </ng-select>
            </div>

            <div class="col-md-12 mb-2">
              <label class="form-label fw-bold">Mô tả công việc <span class="text-danger fw-bold">*</span></label>
              <textarea class="form-control" rows="3" formControlName="description"></textarea>
              <div
                *ngIf="jobForm.get('description')?.invalid && (jobForm.get('description')?.dirty || jobForm.get('description')?.touched)"
                class="text-danger">Mô tả công việc không được để trống.</div>
            </div>

            <div class="col-md-12 mb-2">
              <label class="form-label fw-bold">Yêu cầu ứng viên <span class="text-danger fw-bold">*</span></label>
              <textarea class="form-control" rows="3" formControlName="requirement"></textarea>
              <div
                *ngIf="jobForm.get('requirement')?.invalid && (jobForm.get('requirement')?.dirty || jobForm.get('requirement')?.touched)"
                class="text-danger">Yêu cầu ứng viên không được để trống.</div>
            </div>

            <div class="col-md-12">
              <label class="form-label fw-bold">Quyền lợi <span class="text-danger fw-bold">*</span></label>
              <textarea class="form-control" rows="3" formControlName="benefit"></textarea>
              <div
                *ngIf="jobForm.get('benefit')?.invalid && (jobForm.get('benefit')?.dirty || jobForm.get('benefit')?.touched)"
                class="text-danger">Quyền lợi không được để trống.</div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary" [disabled]="jobForm.invalid">Lưu thay đổi</button>
          <button type="button" class="btn btn-secondary" (click)="openConfirm('cancelUpdateJob')">Hủy</button>
        </div>
      </form>
    </div>
  </div>
</div>
